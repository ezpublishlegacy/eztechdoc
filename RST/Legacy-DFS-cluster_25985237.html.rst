#. `eZ Publish Platform 5.x <index.html>`__
#. `eZ Publish Platform
   Documentation <eZ-Publish-Platform-Documentation_1114149.html>`__
#. `Development & Administration Guides <6291674.html>`__
#. `Features <Features_12781009.html>`__
#. `Binary files handling <Binary-files-handling_25264299.html>`__

eZ Publish Platform 5.x : Legacy DFS cluster
============================================

Created by sarah.haim-lubczanski@ez.no, last modified by
bertrand.dunogier@ez.no on Nov 06, 2014

5.4 / 2014.11

What it is meant for
--------------------

The \ ``legacy_dfs_cluster`` IO metadata handler can be used to store
images on NFS, while remaining compatible with legacy, using the `DFS
Cluster file
handler <https://doc.ez.no/eZ-Publish/Technical-manual/5.x/Features/Clustering/Cluster-File-Handlers#eztoc132713_4>`__.
It stores metadata in the ``ezdfsfile`` table from the legacy database.
It is meant to be used to write binarydata to a locally mounted NFS
server.

` <https://github.com/ezsystems/ezpublish-kernel/blob/master/doc/specifications/io/legacy_dfs_cluster.md#configuration>`__\ Configuration
-----------------------------------------------------------------------------------------------------------------------------------------

Icon

This handler requires legacy to be configured to use `DFS
clustering <https://doc.ez.no/eZ-Publish/Technical-manual/5.x/Features/Clustering/Setting-it-up-for-an-eZDFSFileHandler>`__.

Assuming that your database is named ``ezdfs``, configure it, for
instance in ``ezpublish.yml``:

.. code:: theme:

    # set the handlers
    ezpublish:
        system:
            default:
                io:
                    metadata_handler: dfs
                    binarydata_handler: nfs

    # declare the handlers
    ez_io:
        binarydata_handlers:
            nfs:
                flysystem:
                    adapter: nfs_adapter
        metadata_handlers:
            dfs:
                legacy_dfs_cluster:
                    connection: doctrine.dbal.dfs_connection

    # new doctrine connection for the dfs legacy_dfs_cluster metadata handler.
    doctrine:
        dbal:
            connections:
                dfs:
                    driver: pdo_mysql
                    host: 127.0.0.1
                    port: 3306
                    dbname: ezdfs
                    user: root
                    password: "rootpassword"
                    charset: UTF8

    # new flysystem adapter for the nfs metadata handler
    oneup_flysystem:
        adapters:
            nfs:
                local:
                    # The last part, $var_dir$/$storage_dir$, is required for legacy compatibility
                    directory: "/path/to/nfs/$var_dir$/$storage_dir$"

 

::

     

Icon

**Important**: take good note of the ``$var_dir$/$storage_dir$`` part
for the NFS path. Legacy expects this path to exist on the NFS mount in
order to be able to read and write files.

` <https://github.com/ezsystems/ezpublish-kernel/blob/master/doc/specifications/io/legacy_dfs_cluster.md#web-server-rewrite-rules>`__\ Web server rewrite rules.
----------------------------------------------------------------------------------------------------------------------------------------------------------------

The default eZ Publish rewrite rules will let image requests be served
directly from disk. With native support, files matching
``^/var/([^/]+/)?storage/images(-versioned)?/.*`` have to be sent to the
normal index.php

In any case, this specific rewrite rule must be placed without the ones
that "ignore" image files and just let the web server serve the files.

` <https://github.com/ezsystems/ezpublish-kernel/blob/master/doc/specifications/io/legacy_dfs_cluster.md#apache>`__\ Apache
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code:: theme:

    RewriteRule ^/var/([^/]+/)?storage/images(-versioned)?/.* /index.php [L]

` <https://github.com/ezsystems/ezpublish-kernel/blob/master/doc/specifications/io/legacy_dfs_cluster.md#nginx>`__\ nginx
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code:: theme:

    rewrite "^/var/([^/]+/)?storage/images(-versioned)?/(.*)" "/index.php" break;

Document generated by Confluence on Mar 03, 2015 15:12
